module "ecs" {
  source                                 = "./modules/ecs"
  name                                   = var.name
  application                            = var.application
  environment                            = var.environment
  managedby                              = var.managedby
  label_order                            = var.label_order
  attributes                             = var.attributes
  tags                                   = var.tags
  image_id                               = var.image_id
  spot_image_id                          = var.spot_image_id
  instance_type                          = var.instance_type
  vpc_id                                 = var.vpc_id
  subnet_ids                             = var.subnet_ids
  health_check_type                      = var.health_check_type
  min_size                               = var.min_size
  max_size                               = var.max_size
  spot_max_size                          = var.spot_max_size
  spot_min_size                          = var.spot_min_size
  spot_enabled                           = var.spot_enabled
  spot_scale_down_desired                = var.spot_scale_down_desired
  spot_scale_up_desired                  = var.spot_scale_up_desired
  scale_up_desired                       = var.scale_up_desired
  scale_down_desired                     = var.scale_down_desired
  schedule_enabled                       = var.schedule_enabled
  spot_schedule_enabled                  = var.spot_schedule_enabled
  scheduler_down                         = var.scheduler_down
  scheduler_up                           = var.scheduler_up
  min_size_scaledown                     = var.min_size_scaledown
  max_size_scaledown                     = var.max_size_scaledown
  spot_min_size_scaledown                = var.spot_min_size_scaledown
  spot_max_size_scaledown                = var.spot_max_size_scaledown
  max_price                              = var.max_price
  volume_size                            = var.volume_size
  ebs_encryption                         = var.ebs_encryption
  kms_key_arn                            = var.kms_key_arn
  volume_type                            = var.volume_type
  spot_instance_type                     = var.spot_instance_type
  load_balancers                         = var.load_balancers
  target_group_arns                      = var.target_group_arns
  wait_for_capacity_timeout              = var.wait_for_capacity_timeout
  associate_public_ip_address            = var.associate_public_ip_address
  additional_security_group_ids          = var.additional_security_group_ids
  enabled                                = var.enabled
  fargate_enabled                        = var.fargate_enabled
  key_name                               = var.key_name
  autoscaling_policies_enabled           = var.autoscaling_policies_enabled
  cpu_utilization_high_threshold_percent = var.cpu_utilization_high_threshold_percent
  cpu_utilization_low_threshold_percent  = var.cpu_utilization_low_threshold_percent
  ecs_logging                            = var.ecs_logging
  ecs_settings_enabled                   = var.ecs_settings_enabled
  fargate_capacity_provider              = var.fargate_capacity_provider
  default_fargate_capacity_provider      = var.default_fargate_capacity_provider
  weight                                 = var.weight
  base                                   = var.base
  lb_security_group                      = var.lb_security_group
  cloudwatch_prefix                      = var.cloudwatch_prefix
}

module "service" {
  source                  = "./modules/service"
  name                    = var.name
  application             = var.application
  environment             = var.environment
  managedby               = var.managedby
  label_order             = var.label_order
  attributes              = var.attributes
  tags                    = var.tags
  type                    = var.type
  enabled                 = var.enabled
  ec2_enabled             = var.ec2_enabled
  fargate_enabled         = var.fargate_enabled
  ec2_cluster_name        = module.ecs.ec2_id
  fargate_cluster_name    = module.ecs.fargate_id
  desired_count           = var.desired_count
  propagate_tags          = var.propagate_tags
  scheduling_strategy     = var.scheduling_strategy
  ec2_task_definition     = module.task-definition.ec2_arn
  fargate_task_definition = module.task-definition.fargate_arn
  ec2_capacity_provider   = module.ecs.autoscaling_group_name
  weight                  = var.weight
  base                    = var.base
  target_group_arn        = var.target_group_arn
  container_name          = var.container_name
  container_port          = var.container_port
  subnets                 = var.subnet_ids
  security_groups         = var.service_lb_security_group
  assign_public_ip        = var.assign_public_ip
  network_mode            = var.network_mode
  enable_ecs_managed_tags = var.enable_ecs_managed_tags
}

module "task-definition" {
  source             = "./modules/task-definition"
  name               = var.name
  application        = var.application
  environment        = var.environment
  managedby          = var.managedby
  label_order        = var.label_order
  attributes         = var.attributes
  tags               = var.tags
  enabled            = var.enabled
  ec2_enabled        = var.ec2_enabled
  fargate_enabled    = var.fargate_enabled
  task_role_arn      = var.task_role_arn
  execution_role_arn = var.execution_role_arn
  network_mode       = var.network_mode
  ipc_mode           = var.ipc_mode
  pid_mode           = var.pid_mode
  cpu                = var.cpu
  memory             = var.memory
}
